# Email Reports Structure

This document describes the structure and format of success email reports generated by The Alchemiser trading system.

## Overview

The Alchemiser sends automated email notifications after each trading execution. These emails provide a comprehensive overview of strategy signals, portfolio rebalancing actions, and order execution details.

## Email Structure

The success email follows this logical flow:

### 1. Header
- Application name and logo
- Status banner (Success/Failure with color coding)
- Trading mode indicator (PAPER/LIVE)

### 2. Signal Summary
**Purpose**: Provides a quick, human-readable overview of what strategies triggered and why.

**Location**: Top section immediately after the header

**Content**:
- Individual strategy signals with human-readable reasoning
- Consolidated portfolio allocation across all strategies

**Example**:
```
📊 Signal Summary

Nuclear: Nuclear strategy triggered: RSI conditions met on SPY and TQQQ, allocation set to 75.0% → BUY TQQQ
Quantum: Quantum strategy triggered: conditions satisfied, allocation set to 25.0% → BUY RGTI

Consolidated Signal:
75.0% TQQQ / 25.0% RGTI
```

**Key Features**:
- DSL technical expressions are parsed into natural language
- Strategy names are clearly displayed
- Signal actions (BUY/SELL/HOLD) are included
- Allocation percentages are shown

### 3. Execution Summary
**Purpose**: High-level summary of execution status

**Content**:
- Success/failure status
- Number of orders executed
- Brief description of completion

### 4. Strategy Signals (Detailed)
**Purpose**: Detailed breakdown of each strategy's decision logic

**Location**: After Signal Summary, before Portfolio Rebalancing Plan

**Content**:
- Strategy name
- Action (BUY/SELL/HOLD) with color coding
- Target symbol(s)
- Technical analysis/reasoning (in table format)

**Example**:
```
🎯 Strategy Signals

┌──────────┬────────┬────────┬────────────────────────────────┐
│ Strategy │ Action │ Target │ Analysis                       │
├──────────┼────────┼────────┼────────────────────────────────┤
│ NUCLEAR  │ BUY    │ TQQQ   │ Nuclear: ✓ SPY RSI(10)>79 →  │
│          │        │        │ ✓ TQQQ RSI(10)<81 → 75.0%...  │
└──────────┴────────┴────────┴────────────────────────────────┘
```

### 5. Portfolio Rebalancing Plan
**Purpose**: Shows how the portfolio needs to be adjusted to meet target allocations

**Location**: After Strategy Signals, before Order Execution Details

**Content**:
- Symbol
- Target % (desired allocation)
- Current % (allocation before rebalancing)
- Action (BUY/SELL/HOLD) based on difference

**Example**:
```
📊 Portfolio Rebalancing Plan

┌────────┬──────────┬───────────┬────────┐
│ Symbol │ Target % │ Current % │ Action │
├────────┼──────────┼───────────┼────────┤
│ TQQQ   │ 75.0%    │ 50.0%     │ BUY    │
│ SOXL   │ 25.0%    │ 50.0%     │ SELL   │
└────────┴──────────┴───────────┴────────┘
```

**Key Features**:
- Target % shows desired allocation from strategy
- Current % shows actual portfolio state before execution
- Action indicates what trade needs to be made
- Color coding: BUY (green), SELL (red), HOLD (gray)

### 6. Market Regime Analysis (Optional)
**Purpose**: Provides context on overall market conditions

**Content** (when SPY data available):
- Market trend (Bullish/Bearish based on price vs 200-day MA)
- RSI status (Overbought/Oversold/Neutral)
- Current price vs moving average comparison

### 7. Order Execution Details
**Purpose**: Shows specific trades that were executed

**Location**: Final section

**Content**:
- Action (BUY/SELL)
- Symbol
- Quantity
- Status (Success/Failed)

**Example**:
```
📋 Order Execution Details

┌────────┬────────┬──────────┬─────────┐
│ Action │ Symbol │ Quantity │ Status  │
├────────┼────────┼──────────┼─────────┤
│ BUY    │ TQQQ   │ 10.00    │ Success │
│ SELL   │ SOXL   │ 5.00     │ Success │
└────────┴────────┴──────────┴─────────┘
```

### 8. Footer
- Application signature
- Timestamp
- System information

## Section Ordering Rationale

The sections are ordered to follow the logical flow of information:

1. **Signal Summary** → Quick overview of what happened
2. **Strategy Signals** → Why it happened (strategy logic)
3. **Portfolio Rebalancing** → What needs to change
4. **Market Regime** → Market context
5. **Order Execution** → What actually executed

This ordering allows readers to quickly understand:
- What signals were generated
- Why those signals were generated
- How the portfolio will be adjusted
- What trades were executed

## Data Accuracy Notes

### Current % Calculation
The "Current %" in the Portfolio Rebalancing Plan is calculated from:
1. **First choice**: `final_portfolio_state.positions` (after execution)
2. **Fallback**: `account_info_before.positions` (before execution)
3. **Legacy fallback**: `account_info_after.open_positions`

The system calculates:
```
Current % = (Symbol Market Value) / (Total Portfolio Value)
```

If no position data is available, Current % defaults to 0.0%.

### Signal Reasoning Parsing
DSL strategy reasoning strings are automatically parsed into human-readable text:

**Technical DSL format**:
```
Nuclear: ✓ SPY RSI(10)>79 → ✓ TQQQ RSI(10)<81 → 75.0% allocation
```

**Human-readable format**:
```
Nuclear strategy triggered: RSI conditions met on SPY and TQQQ, allocation set to 75.0%
```

The parser extracts:
- Strategy name
- Indicator conditions (RSI, max drawdown, etc.)
- Symbols involved
- Allocation percentages

## Neutral Reporting Policy

All email reports follow a **neutral reporting policy**:
- No dollar values shown (account balances, trade values, P&L)
- Percentages only for allocations
- Quantity shown for trades (share count)
- Status indicators (Success/Failed)

This policy ensures:
- Privacy and security of financial data
- Focus on strategy performance vs. monetary outcomes
- Consistent format across paper and live trading

## Color Coding

The emails use consistent color coding:

- **Green (#10B981)**: BUY actions, positive status, success
- **Red (#EF4444)**: SELL actions, errors, failures
- **Gray (#6B7280)**: HOLD actions, neutral status
- **Blue (#3B82F6)**: Information, headers, emphasis
- **Orange (#F59E0B)**: Warnings, cautionary information

## Technical Implementation

Email templates are built using:
- Pure HTML with inline CSS (email client compatibility)
- Table-based layouts (maximum compatibility)
- Static content only (no JavaScript)
- Pydantic DTOs for type safety
- Template builder pattern for modularity

**Key Files**:
- `the_alchemiser/shared/notifications/templates/multi_strategy.py` - Main orchestrator
- `the_alchemiser/shared/notifications/templates/signals.py` - Signal formatting
- `the_alchemiser/shared/notifications/templates/portfolio.py` - Portfolio tables
- `the_alchemiser/shared/notifications/templates/base.py` - Base template components

## Version History

- **2025-10-21**: Updated section ordering (Strategy Signals before Portfolio Rebalancing)
- **2025-10-21**: Enhanced Signal Summary with human-readable DSL parsing
- **2025-10-21**: Fixed Current % calculation in Portfolio Rebalancing Plan
- **2025-01-07**: Initial neutral reporting policy implementation
