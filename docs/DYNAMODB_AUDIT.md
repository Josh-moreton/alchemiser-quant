# DynamoDB Database Audit

**Date**: 2026-02-11
**Branch**: copilot/remove-rebalance-planner-aggregation
**Scope**: All 11 DynamoDB tables in template.yaml

---

## Table Inventory

| # | Table | Key Schema | GSIs | TTL | PITR | Purpose |
|---|-------|-----------|------|-----|------|---------|
| 1 | TradeLedgerTable | PK/SK | 6 (GSI1-GSI6) | None | Yes | Trade/signal/lot storage |
| 2 | ExecutionRunsTable | PK/SK | 0 | TTL | No | Execution run state tracking |
| 3 | RebalancePlanTable | PK/SK | 1 (GSI1) | ttl | Yes | Rebalance plan audit trail |
| 4 | MarketDataFetchRequestsTable | PK only | 0 | ttl | No | Dedup concurrent data fetches |
| 5 | BadDataMarkersTable | PK/SK | 0 | TTL | No | Track symbols needing re-fetch |
| 6 | HedgePositionsTable | PK/SK | 1 (GSI1) | ttl | No | Active hedge position tracking |
| 7 | HedgeHistoryTable | account_id/timestamp_action | 0 | ttl | No | Hedge action audit trail |
| 8 | HedgeKillSwitchTable | switch_id only | 0 | None | No | Emergency hedge disable |
| 9 | IVHistoryTable | underlying_symbol/record_date | 0 | ttl | No | Daily IV snapshots for percentile |
| 10 | GroupHistoricalSelectionsTable | group_id/record_date | 0 | ttl | No | Group evaluation cache |
| 11 | AccountDataTable | PK/SK | 0 | ExpiresAt | Yes | Account snapshots for dashboard |
| 12 | StrategyPerformanceTable | PK/SK | 0 | ExpiresAt | No | Strategy metrics for dashboard |

---

## Issues Found

### CRITICAL: Missing Pagination in TradeLedger Query Methods

**Severity**: HIGH - affects data correctness
**Files**: `shared_layer/python/the_alchemiser/shared/repositories/dynamodb_trade_ledger_repository.py`

The following query methods do NOT handle `LastEvaluatedKey` pagination. DynamoDB returns at most 1 MB per request. If any of these result sets exceeds 1 MB, data is **silently truncated**:

| Method | Line | GSI Used | Impact |
|--------|------|----------|--------|
| `query_trades_by_correlation()` | 208-226 | GSI1 | Incomplete trade history per run |
| `query_trades_by_symbol()` | 228-255 | GSI2 | Dashboard shows partial symbol data |
| `query_trades_by_strategy()` | 257-299 | GSI3 | Missed trades in strategy attribution |
| `query_signals_by_correlation()` | 605-625 | GSI1 | Incomplete signal execution tracking |
| `query_signals_by_symbol()` | 627-659 | GSI2 | Dashboard shows partial signals |
| `query_signals_by_strategy()` | 661-697 | GSI3 | Incomplete strategy signal history |
| `query_signals_by_state()` | 699-735 | GSI4 | Incomplete lifecycle state queries |
| `query_all_lots_by_strategy()` | 1034-1065 | GSI5 | **Incorrect P&L calculations** |

The `query_all_lots_by_strategy()` issue is particularly dangerous: if a strategy accumulates more than 1 MB of LOT items, `get_strategy_summary()` will compute metrics on a partial dataset, producing silently wrong P&L figures.

**Contrast**: Methods like `discover_strategies_with_closed_lots()` (line 1078-1112), `list_strategy_metadata()` (line 1254-1285), and all dashboard methods in `dashboard/data/strategy.py` DO handle pagination correctly.

**Fix**: Add standard pagination loop to all affected methods:
```python
items = response.get("Items", [])
while "LastEvaluatedKey" in response:
    response = self._table.query(**kwargs, ExclusiveStartKey=response["LastEvaluatedKey"])
    items.extend(response.get("Items", []))
```

---

### HIGH: TradeLedgerTable Has No TTL - Unbounded Growth

**Severity**: HIGH - cost and performance impact over time

The TradeLedger stores 6 entity types with no expiration:
- TRADE items (every fill from every execution run)
- STRATEGY_TRADE items (strategy attribution links)
- SIGNAL items (every signal from every strategy run)
- STRATEGY_LOT items (position lots with exit records)
- STRATEGY_METADATA items (strategy definitions)

With ~20-50 trades/day and corresponding signals/lots, this table grows indefinitely. Currently manageable but will become a cost and scan-performance concern over time.

**Note**: PITR is correctly enabled on this table, providing protection against accidental deletes.

**Recommendation**: Add TTL with conservative retention:
- TRADE/STRATEGY_TRADE: 2+ years (tax/audit)
- SIGNAL: 1+ year
- STRATEGY_LOT: 2+ years (P&L tracking)
- STRATEGY_METADATA: No TTL (small, always needed)

---

### MEDIUM: GSI6-SymbolLotsIndex is Unused

**Severity**: MEDIUM - unnecessary cost

GSI6 (`GSI6PK = SYMBOL_LOTS#{symbol}`, `GSI6SK = OPEN/CLOSED#{...}`) is defined on TradeLedgerTable with `Projection: ALL` (full data duplication in index).

**Generated by**: `shared_layer/python/the_alchemiser/shared/schemas/strategy_lot.py:282-283` - keys are written to every LOT item.

**Queried by**: Nothing. Zero queries found anywhere in the codebase.

**Cost**: Every LOT write incurs an additional GSI6 write. With `ALL` projection, each LOT item is fully duplicated in the index.

**Stated purpose**: "cross-strategy position analysis" (query all lots for a single symbol across all strategies).

**Recommendation**: Either remove GSI6 and stop generating GSI6PK/GSI6SK attributes, or implement the cross-strategy position query it was designed for.

---

### MEDIUM: GSI4 Name Mismatch

**Severity**: LOW - documentation/confusion only

`template.yaml` line 254 labels this GSI as "GSI4-CorrelationSnapshotIndex", but it actually queries signals by **lifecycle state**:

- `GSI4PK = STATE#{lifecycle_state}`
- `GSI4SK = SIGNAL#{timestamp}#{signal_id}`
- Used by `query_signals_by_state()` at line 699

The name "CorrelationSnapshotIndex" is misleading. Should be renamed to "GSI4-SignalStateIndex" or "GSI4-LifecycleStateIndex" in template.yaml comments.

---

### MEDIUM: TTL Attribute Naming Inconsistency

Three different TTL attribute names are used across tables:

| TTL Name | Tables |
|----------|--------|
| `TTL` | ExecutionRunsTable, BadDataMarkersTable |
| `ttl` | RebalancePlanTable, MarketDataFetchRequestsTable, HedgePositionsTable, HedgeHistoryTable, IVHistoryTable, GroupHistoricalSelectionsTable |
| `ExpiresAt` | AccountDataTable, StrategyPerformanceTable |

This is not a functional issue (DynamoDB TTL works regardless of attribute name), but it increases cognitive load for developers and makes cross-table tooling harder.

**Recommendation**: Standardize to a single name. `ExpiresAt` is the most descriptive, but `ttl` is most prevalent. Pick one and migrate over time.

---

### MEDIUM: Key Schema Design Inconsistency

Some tables use generic `PK/SK` single-table design, others use domain-specific named keys:

| Pattern | Tables |
|---------|--------|
| Generic `PK`/`SK` | TradeLedger, ExecutionRuns, RebalancePlan, HedgePositions, BadDataMarkers, AccountData, StrategyPerformance |
| Named keys | HedgeHistory (`account_id`/`timestamp_action`), IVHistory (`underlying_symbol`/`record_date`), GroupHistoricalSelections (`group_id`/`record_date`), HedgeKillSwitch (`switch_id`), MarketDataFetchRequests (`PK` only) |

The named-key tables are simpler single-entity tables, so this is defensible. The inconsistency only matters if you plan to consolidate tables or build generic tooling.

---

### LOW: Dashboard Bypasses Repository Pattern

**Severity**: LOW - maintainability concern

Several dashboard pages perform direct `boto3.Table()` operations instead of going through `DynamoDBTradeLedgerRepository`:

| File | Operation | Table |
|------|-----------|-------|
| `dashboard/pages/symbol_analytics.py:89` | Direct client query | TradeLedger |
| `dashboard/pages/trade_history.py:71` | Direct table.scan() | TradeLedger |
| `dashboard/pages/execution_quality.py:77` | Direct table.scan() | TradeLedger |
| `dashboard/data/strategy.py:430` | Direct table.scan() | TradeLedger |

This creates duplicated query logic and inconsistent error handling. The dashboard is a separate concern (not deployed as Lambda), so this is a lower priority.

---

### LOW: Strategy Performance Table Missing PITR

**Severity**: LOW

`StrategyPerformanceTable` does not have Point-in-Time Recovery enabled, unlike TradeLedgerTable, RebalancePlanTable, and AccountDataTable. Data is regenerable from TradeLedger via the backfill script, so this is low risk but inconsistent with the pattern for dashboard-facing tables.

---

## IAM Permissions Audit

All Lambda roles were cross-checked against actual code operations:

| Lambda | Role | Tables Accessed | Verdict |
|--------|------|-----------------|---------|
| Strategy Orchestrator | StrategyOrchestratorExecutionRole | None | CORRECT - dispatches only |
| Strategy Worker | StrategyExecutionRole | TradeLedger, GroupHistorical, ExecutionRuns, RebalancePlan | Minor over-grant: Query on TradeLedger not used in code |
| Execution | ExecutionExecutionRole | TradeLedger, ExecutionRuns | CORRECT |
| Trade Aggregator | TradeAggregatorExecutionRole | ExecutionRuns | CORRECT |
| Notifications | NotificationsExecutionRole | TradeLedger (read-only) | CORRECT - Scan is used for strategy discovery |
| Strategy Performance | StrategyPerformanceExecutionRole | TradeLedger (read), StrategyPerformance (write) | CORRECT - Scan is used for lot discovery |
| Hedge Evaluator | HedgeEvaluatorExecutionRole | HedgePositions, HedgeHistory, HedgeKillSwitch, IVHistory | CORRECT |
| Hedge Executor | HedgeExecutorExecutionRole | HedgePositions, HedgeHistory, HedgeKillSwitch | CORRECT |
| Hedge Roll Manager | HedgeRollManagerExecutionRole | HedgePositions, HedgeHistory | CORRECT |
| Data | DataExecutionRole | MarketDataFetchRequests, BadDataMarkers | CORRECT |
| Account Data | AccountDataExecutionRole | AccountData | CORRECT |
| Schedule Manager | ScheduleManagerExecutionRole | None | CORRECT |

All `/index/*` suffixes for GSI access are present where needed.

---

## Per-Table Detail

### 1. TradeLedgerTable

**Single-table design** storing 6 entity types:

| Entity | PK Pattern | SK Pattern | GSI Usage |
|--------|-----------|-----------|-----------|
| TRADE | `TRADE#{order_id}` | `METADATA` | GSI1: CORR#, GSI2: SYMBOL# |
| STRATEGY_TRADE | `STRATEGY#{name}` | `TRADE#{ts}#{id}` | GSI3: STRATEGY# |
| SIGNAL | `SIGNAL#{signal_id}` | `METADATA` | GSI1, GSI2, GSI3, GSI4 |
| STRATEGY_METADATA | `STRATEGY#{name}` | `METADATA` | GSI3: STRATEGIES |
| STRATEGY_LOT | `LOT#{lot_id}` | `METADATA` | GSI5: STRATEGY_LOTS#, GSI6: SYMBOL_LOTS# (unused) |
| STRATEGY_METADATA list | `STRATEGIES` | `METADATA#{name}` | GSI3 |

**GSI Health**:
- GSI1 (Correlation): ACTIVE
- GSI2 (Symbol): ACTIVE
- GSI3 (Strategy): ACTIVE
- GSI4 (Signal State): ACTIVE but misnamed
- GSI5 (Strategy Lots): ACTIVE
- GSI6 (Symbol Lots): **UNUSED**

### 2. ExecutionRunsTable

**Entity types**: Execution run state and per-strategy rebalance session state.
**Used by**: Strategy Worker, Execution Lambda, Trade Aggregator.
**TTL**: Enabled on `TTL` attribute. Items expire after runs complete.

### 3. RebalancePlanTable

**Entity types**: Serialized RebalancePlan documents.
**GSI1**: CorrelationIndex for tracing workflow decisions.
**TTL**: 90 days. **PITR**: Enabled.
**Access**: Strategy Worker (write), read via GSI1 for debugging.

### 4. MarketDataFetchRequestsTable

**Simple deduplication table**: PK-only (no sort key).
**TTL**: Enabled - requests expire after processing window.
**Used by**: Data Lambda only.

### 5. BadDataMarkersTable

**Tracks symbols/dates needing re-fetch**.
**TTL**: Enabled on `TTL` attribute.
**Used by**: Data Lambda only.

### 6. HedgePositionsTable

**Active hedge position lifecycle tracking**.
**GSI1**: UnderlyingExpirationIndex for roll management.
**TTL**: Enabled on `ttl`.
**Used by**: Hedge Evaluator, Hedge Executor, Hedge Roll Manager.

### 7. HedgeHistoryTable

**Append-only audit trail** of hedge actions (OPENED, ROLLED, CLOSED, etc.).
**Named keys**: `account_id` / `timestamp_action`.
**TTL**: Enabled on `ttl`.
**Used by**: All hedge Lambdas (write-only - PutItem).

### 8. HedgeKillSwitchTable

**Emergency toggle** - single-key design (`switch_id`).
**No TTL** (intentional - kill switch state must persist).
**No PITR** (small, easily recreated).
**Used by**: Hedge Evaluator, Hedge Executor.

### 9. IVHistoryTable

**252-day rolling IV snapshots** for percentile calculations.
**Named keys**: `underlying_symbol` / `record_date`.
**TTL**: Enabled on `ttl`.
**Used by**: Hedge Evaluator only.

### 10. GroupHistoricalSelectionsTable

**Caches daily group evaluations** for portfolio scoring.
**Named keys**: `group_id` / `record_date`.
**TTL**: Enabled on `ttl`.
**Used by**: Strategy Worker only.

### 11. AccountDataTable

**Dashboard data source** - account snapshots, positions, daily PnL.
**TTL**: Enabled on `ExpiresAt`. **PITR**: Enabled.
**Used by**: Account Data Lambda (write), Dashboard (read).

### 12. StrategyPerformanceTable

**Per-strategy performance metrics** for dashboard.
**TTL**: Enabled on `ExpiresAt` (90 days).
**Used by**: Strategy Performance Lambda (write), Dashboard (read).

---

## Priority Action Items

| # | Issue | Severity | Effort | Impact |
|---|-------|----------|--------|--------|
| 1 | Add pagination to TradeLedger query methods | HIGH | Medium | Prevents silent data truncation and incorrect P&L |
| 2 | Add TTL to TradeLedgerTable | HIGH | Medium | Controls unbounded storage growth |
| 3 | Remove or implement GSI6 | MEDIUM | Low | Saves index write costs |
| 4 | Rename GSI4 comment in template.yaml | LOW | Trivial | Reduces developer confusion |
| 5 | Standardize TTL attribute naming | LOW | Medium | Consistency across tables |
| 6 | Add PITR to StrategyPerformanceTable | LOW | Trivial | Consistent protection for dashboard tables |
| 7 | Remove over-granted Query from StrategyExecutionRole | LOW | Trivial | Least-privilege cleanup |
