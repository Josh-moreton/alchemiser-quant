# Pre-commit hooks for The Alchemiser - Simplified, non-blocking workflow
# Philosophy: Catch obvious mistakes, don't block commits
# Run ruff/mypy manually with: make format, make type-check
# All tool configurations centralized in pyproject.toml

repos:

  # Code Quality: Ruff (formatting, linting, import sorting)
  - repo: local
    hooks:
      # Step 1: Format code (includes whitespace normalization)
      - id: ruff-format
        name: Ruff Format (whitespace, style)
        entry: poetry run ruff format
        language: system
        types: [python]
        files: ^the_alchemiser/
        pass_filenames: true
        stages: [pre-commit]

      # Step 2: Auto-fix lint violations
      - id: ruff-fix
        name: Ruff Auto-fix (safe fixes)
        entry: poetry run ruff check --fix
        language: system
        types: [python]
        files: ^the_alchemiser/
        pass_filenames: true
        stages: [pre-commit]

  # Type Safety: MyPy strict type checking
  # NOTE: Temporarily disabled due to duplicate module issue in codebase
  # both execution_v2/core/smart_execution_strategy.py AND
  # execution_v2/core/smart_execution_strategy/__init__.py exist
  # Run manually: poetry run mypy the_alchemiser/ --config-file=pyproject.toml
  - repo: local
    hooks:
      - id: mypy
        name: MyPy Type Check (strict mode)
        entry: poetry run mypy the_alchemiser/ --config-file=pyproject.toml
        language: system
        types: [python]
        files: ^the_alchemiser/
        pass_filenames: false
        require_serial: true  # MyPy cache not thread-safe
        stages: [pre-commit]

  # Architecture: Import boundary enforcement
  - repo: local
    hooks:
      - id: import-linter
        name: Import Linter (architecture boundaries)
        entry: bash -c 'poetry run lint-imports --config pyproject.toml || poetry run python -m importlinter --config pyproject.toml'
        language: system
        types: [python]
        files: ^the_alchemiser/
        pass_filenames: false  # Analyzes entire module graph
        stages: [pre-commit]

  # Security: Bandit (security issue detection)
  - repo: local
    hooks:
      - id: bandit
        name: Bandit Security Scan
        entry: poetry run bandit -c pyproject.toml -r the_alchemiser/
        language: system
        types: [python]
        files: ^the_alchemiser/
        pass_filenames: false
        stages: [pre-commit]
