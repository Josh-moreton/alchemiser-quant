# yaml-language-server: $schema=https://raw.githubusercontent.com/aws/serverless-application-model/main/samtranslator/validator/sam_schema/schema.json
# yaml-language-server: disable-validation
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  The Alchemiser Quantitative Trading System

  Multi-strategy algorithmic trading engine deployed as an AWS Lambda Function

Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
      - ephemeral
    Description: Deployment stage (dev, prod, or ephemeral)
  
  StackName:
    Type: String
    Default: ""
    Description: Optional override for stack-specific resource naming (used for ephemeral stacks)
  
  Env:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
      - ephemeral
    Description: Environment type for resource configuration
  
  ArtifactPrefix:
    Type: String
    Default: ""
    Description: S3 prefix for artifacts (used for ephemeral stack isolation)

  AlpacaKey:
    Type: String
    Default: ""
    NoEcho: true
    Description: Alpaca API Key (used only in dev; leave blank for prod)

  AlpacaSecret:
    Type: String
    Default: ""
    NoEcho: true
    Description: Alpaca API Secret (used only in dev; leave blank for prod)

  AlpacaEndpoint:
    Type: String
    Default: https://paper-api.alpaca.markets/v2
    Description: Alpaca API endpoint; defaults to paper for dev, live is used for prod

  EmailPassword:
    Type: String
    Default: ""
    NoEcho: true
    Description: Email SMTP password for dev notifications (optional)

  # Runtime configuration parameters (override via CD for each environment)
  DslMaxWorkers:
    Type: String
    Default: "7"
    Description: ALCHEMISER_DSL_MAX_WORKERS (string to align with Lambda env var type)

  # Margin/Leverage configuration
  EquityDeploymentPct:
    Type: String
    Default: "1.0"
    Description: ALPACA__EQUITY_DEPLOYMENT_PCT - percentage of equity to deploy (1.0=100%, 1.10=110% with margin)

  ProdEquityDeploymentPct:
    Type: String
    Default: "1.0"
    Description: Equity deployment percentage for production (conservative default)

  # Production-only parameters (only used when Stage=prod)
  ProdAlpacaKey:
    Type: String
    Default: ""
    NoEcho: true
    Description: Alpaca API Key for production (required when Stage=prod)

  ProdAlpacaSecret:
    Type: String
    Default: ""
    NoEcho: true
    Description: Alpaca API Secret for production (required when Stage=prod)

  ProdAlpacaEndpoint:
    Type: String
    Default: https://api.alpaca.markets
    Description: Alpaca API endpoint for production

  ProdEmailPassword:
    Type: String
    Default: ""
    NoEcho: true
    Description: Email SMTP password for production notifications (optional)

  # Strategy configuration: now defined in code defaults. Override via env only if required.

Conditions:
  IsDev: !Equals [ !Ref Stage, dev ]
  IsEphemeral: !Equals [ !Ref Stage, ephemeral ]
  HasStackName: !Not [ !Equals [ !Ref StackName, "" ] ]
  UseStackNameForResources: !Or [ !Condition IsEphemeral, !Condition HasStackName ]

Globals:
  Function:
    Timeout: 900 # 15 minutes - max for Lambda
    MemorySize: 512
    Environment:
      Variables:
        # Stage awareness for code-level profiles
        APP__STAGE: !If [ IsDev, "dev", "prod" ]
        # Alpaca Configuration
        ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
        ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
        ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
        # Email Configuration
        EMAIL__SMTP_SERVER: smtp.mail.me.com
        EMAIL__SMTP_PORT: 587
        EMAIL__FROM_EMAIL: joshuamoreton1@icloud.com
        EMAIL__TO_EMAIL: notifications@rwxt.org
        EMAIL__NEUTRAL_MODE: true
        EMAIL__PASSWORD: !If [ IsDev, !Ref EmailPassword, !Ref ProdEmailPassword ]
        # Strategy DSL configuration now comes from code defaults; override via env only if necessary
        # STRATEGY__DSL_FILES: '["1-KMLM.clj","2-Nuclear.clj","5-Coin.clj","6-TQQQ-FLT.clj"]'
        # STRATEGY__DSL_ALLOCATIONS: '{"1-KMLM.clj":0.4,"2-Nuclear.clj":0.25,"5-Coin.clj":0.1,"6-TQQQ-FLT.clj":0.25}'

        # DSL parallelism configuration
        ALCHEMISER_DSL_MAX_WORKERS: !Ref DslMaxWorkers

        # Margin/Leverage configuration - controls how much of equity to deploy
        # 1.0 = 100% of equity (no margin), 1.10 = 110% (10% margin usage)
        ALPACA__EQUITY_DEPLOYMENT_PCT: !If [ IsDev, !Ref EquityDeploymentPct, !Ref ProdEquityDeploymentPct ]

        # Trade ledger DynamoDB table
        TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable

  # Strategy configuration now packaged with code; env overrides optional

  # (no additional Globals keys)

Resources:
  # DynamoDB Table for trade ledger persistence
  TradeLedgerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !If 
        - UseStackNameForResources
        - !Sub "${StackName}-trade-ledger"
        - !Sub "alchemiser-${Stage}-trade-ledger"
      BillingMode: PAY_PER_REQUEST
      
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
        - AttributeName: GSI3PK
          AttributeType: S
        - AttributeName: GSI3SK
          AttributeType: S
        - AttributeName: GSI4PK
          AttributeType: S
        - AttributeName: GSI4SK
          AttributeType: S
        - AttributeName: GSI5PK
          AttributeType: S
        - AttributeName: GSI5SK
          AttributeType: S
        - AttributeName: GSI6PK
          AttributeType: S
        - AttributeName: GSI6SK
          AttributeType: S
      
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      
      GlobalSecondaryIndexes:
        # GSI1: Query by correlation_id
        - IndexName: GSI1-CorrelationIndex
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        
        # GSI2: Query by symbol
        - IndexName: GSI2-SymbolIndex
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        
        # GSI3: Query by strategy
        - IndexName: GSI3-StrategyIndex
          KeySchema:
            - AttributeName: GSI3PK
              KeyType: HASH
            - AttributeName: GSI3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        
        # GSI4: Query snapshots by correlation_id
        - IndexName: GSI4-CorrelationSnapshotIndex
          KeySchema:
            - AttributeName: GSI4PK
              KeyType: HASH
            - AttributeName: GSI4SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        
        # GSI5: Query strategy lots by strategy name (for FIFO P&L tracking)
        - IndexName: GSI5-StrategyLotsIndex
          KeySchema:
            - AttributeName: GSI5PK
              KeyType: HASH
            - AttributeName: GSI5SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        
        # GSI6: Query strategy lots by symbol (cross-strategy position analysis)
        - IndexName: GSI6-SymbolLotsIndex
          KeySchema:
            - AttributeName: GSI6PK
              KeyType: HASH
            - AttributeName: GSI6SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      
      SSESpecification:
        SSEEnabled: true
        # Use AWS-managed encryption (not KMS) to avoid requiring additional IAM permissions
      
      Tags:
        - Key: Environment
          Value: !Ref Stage
        - Key: Service
          Value: trade-ledger

  # ========== FUNCTION-SPECIFIC LAMBDA LAYERS ==========
  # Each Lambda gets its own optimized layer with only required dependencies
  # boto3/botocore excluded from all layers - Lambda runtime provides them

  # Strategy Layer: pandas + numpy + pyarrow (for S3 Parquet cache) + alpaca-py
  StrategyLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-strategy-deps"
        - !Sub "alchemiser-${Stage}-strategy-deps"
      Description: Strategy Lambda dependencies (pandas, pyarrow, alpaca-py)
      ContentUri: layers/strategy/
      CompatibleRuntimes:
        - python3.12
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.12

  # Portfolio Layer: alpaca-py + pydantic (no pandas/numpy)
  PortfolioLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-portfolio-deps"
        - !Sub "alchemiser-${Stage}-portfolio-deps"
      Description: Portfolio Lambda dependencies (alpaca-py, pydantic)
      ContentUri: layers/portfolio/
      CompatibleRuntimes:
        - python3.12
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.12

  # Execution Layer: alpaca-py + pydantic (no pandas/numpy)
  ExecutionLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-execution-deps"
        - !Sub "alchemiser-${Stage}-execution-deps"
      Description: Execution Lambda dependencies (alpaca-py, pydantic)
      ContentUri: layers/execution/
      CompatibleRuntimes:
        - python3.12
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.12

  # Notifications Layer: pydantic + structlog (minimal footprint)
  NotificationsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-notifications-deps"
        - !Sub "alchemiser-${Stage}-notifications-deps"
      Description: Notifications Lambda dependencies (pydantic, structlog)
      ContentUri: layers/notifications/
      CompatibleRuntimes:
        - python3.12
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.12

  # Data Layer: pandas + numpy + pyarrow + alpaca-py
  DataLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-data-deps"
        - !Sub "alchemiser-${Stage}-data-deps"
      Description: Data Lambda dependencies (pandas, pyarrow, alpaca-py)
      ContentUri: layers/data/
      CompatibleRuntimes:
        - python3.12
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.12

  # ============================================================================
  # MICROSERVICES ARCHITECTURE
  # ============================================================================

  # EventBridge Event Bus for async domain event communication
  AlchemiserEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-events"
        - !Sub "alchemiser-${Stage}-events"

  # SQS Queue for reliable trade execution with DLQ
  ExecutionQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-execution-queue"
        - !Sub "alchemiser-${Stage}-execution-queue"
      VisibilityTimeout: 900  # 15 mins for execution
      MessageRetentionPeriod: 345600  # 4 days
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ExecutionDLQ.Arn
        maxReceiveCount: 3

  ExecutionDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-execution-dlq"
        - !Sub "alchemiser-${Stage}-execution-dlq"
      MessageRetentionPeriod: 1209600  # 14 days

  # SNS Topic for DLQ alerts (very low cost: ~$0.50/million messages)
  DLQAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-dlq-alerts"
        - !Sub "alchemiser-${Stage}-dlq-alerts"
      DisplayName: "Alchemiser DLQ Alert"

  # Email subscription for DLQ alerts
  DLQAlertEmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref DLQAlertTopic
      Protocol: email
      Endpoint: notifications@rwxt.org

  # ========== PERFORMANCE REPORTS S3 BUCKET ==========
  # S3 bucket for strategy performance CSV reports with presigned URL access
  PerformanceReportsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-reports"
        - !Sub "alchemiser-${Stage}-reports"
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldReports
            ExpirationInDays: 30
            Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Environment
          Value: !Ref Stage
        - Key: Service
          Value: performance-reports

  # ========== MARKET DATA S3 BUCKET ==========
  # S3 bucket for historical market data (Parquet files) with versioning
  MarketDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-market-data"
        - !Sub "alchemiser-${Stage}-market-data"
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Environment
          Value: !Ref Stage
        - Key: Service
          Value: market-data

  # ========== TRADING NOTIFICATIONS SNS ==========
  # SNS Topic for trading notifications (trade results, workflow failures)
  TradingNotificationsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-trading-notifications"
        - !Sub "alchemiser-${Stage}-trading-notifications"
      DisplayName: "Alchemiser Trading Notifications"

  # Email subscription for trading notifications
  TradingNotificationsEmailSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref TradingNotificationsTopic
      Protocol: email
      Endpoint: notifications@rwxt.org

  # CloudWatch Alarm for DLQ messages (triggers when messages hit DLQ)
  DLQMessageAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-dlq-messages"
        - !Sub "alchemiser-${Stage}-dlq-messages"
      AlarmDescription: "Alert when messages land in the execution DLQ after 3 failed attempts"
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt ExecutionDLQ.QueueName
      AlarmActions:
        - !Ref DLQAlertTopic
      TreatMissingData: notBreaching

  # Policy to allow EventBridge to send messages to SQS
  ExecutionQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties:
      Queues:
        - !Ref ExecutionQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt ExecutionQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !GetAtt RebalancePlannedRule.Arn

  # EventBridge Rules for event routing
  SignalGeneratedRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-signal-generated"
        - !Sub "alchemiser-${Stage}-signal-generated"
      EventBusName: !Ref AlchemiserEventBus
      EventPattern:
        source:
          - alchemiser.strategy
        detail-type:
          - SignalGenerated
      Targets:
        - Id: PortfolioTarget
          Arn: !GetAtt PortfolioFunction.Arn

  SignalGeneratedPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PortfolioFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt SignalGeneratedRule.Arn

  RebalancePlannedRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-rebalance-planned"
        - !Sub "alchemiser-${Stage}-rebalance-planned"
      EventBusName: !Ref AlchemiserEventBus
      EventPattern:
        source:
          - alchemiser.portfolio
        detail-type:
          - RebalancePlanned
      Targets:
        - Id: ExecutionQueueTarget
          Arn: !GetAtt ExecutionQueue.Arn

  # Strategy Lambda - Signal generation microservice (entry point)
  StrategyFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-strategy"
        - !Sub "alchemiser-${Stage}-strategy"
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.strategy_v2.lambda_handler.lambda_handler
      Role: !GetAtt StrategyExecutionRole.Arn
      Layers:
        - !Ref StrategyLayer
      Timeout: 300
      MemorySize: 1024
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref AlchemiserEventBus
          ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
          ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
          ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
          TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable
          ALCHEMISER_DSL_MAX_WORKERS: !Ref DslMaxWorkers
          MARKET_DATA_BUCKET: !Ref MarketDataBucket
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/**/*.clj'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          - '.env*'
          - 'the_alchemiser/.env*'
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'
          - 'the_alchemiser/.editorconfig'
          - 'the_alchemiser/**/*.md'

  StrategyExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: StrategyPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt TradeLedgerTable.Arn
                  - !Sub "${TradeLedgerTable.Arn}/index/*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt MarketDataBucket.Arn
                  - !Sub "${MarketDataBucket.Arn}/*"

  # Portfolio Lambda - Rebalance planning microservice
  PortfolioFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-portfolio"
        - !Sub "alchemiser-${Stage}-portfolio"
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.portfolio_v2.lambda_handler.lambda_handler
      Role: !GetAtt PortfolioExecutionRole.Arn
      Layers:
        - !Ref PortfolioLayer
      Timeout: 300
      MemorySize: 1024
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref AlchemiserEventBus
          ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
          ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
          ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
          TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/**/*.clj'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          - '.env*'
          - 'the_alchemiser/.env*'
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'
          - 'the_alchemiser/.editorconfig'
          - 'the_alchemiser/**/*.md'

  PortfolioExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: PortfolioPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt TradeLedgerTable.Arn
                  - !Sub "${TradeLedgerTable.Arn}/index/*"

  # Execution Lambda - Trade execution microservice (triggered via SQS)
  ExecutionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-execution"
        - !Sub "alchemiser-${Stage}-execution"
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.execution_v2.lambda_handler.lambda_handler
      Role: !GetAtt ExecutionExecutionRole.Arn
      Layers:
        - !Ref ExecutionLayer
      Timeout: 600
      MemorySize: 1024
      # Note: Concurrency is limited by SQS BatchSize: 1 which processes one message at a time
      # WebSocket connections are cleaned up after each execution via cleanup_all_instances()
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref AlchemiserEventBus
          ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
          ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
          ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
          TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable
      Events:
        ExecutionQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt ExecutionQueue.Arn
            BatchSize: 1
            FunctionResponseTypes:
              - ReportBatchItemFailures
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/**/*.clj'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          - '.env*'
          - 'the_alchemiser/.env*'
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'
          - 'the_alchemiser/.editorconfig'
          - 'the_alchemiser/**/*.md'

  ExecutionExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: ExecutionPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                Resource:
                  - !GetAtt ExecutionQueue.Arn
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                  - dynamodb:BatchWriteItem
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt TradeLedgerTable.Arn
                  - !Sub "${TradeLedgerTable.Arn}/index/*"

  # ========== NOTIFICATIONS LAMBDA ==========
  # Consumes TradeExecuted and WorkflowFailed events and sends email notifications
  NotificationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-notifications"
        - !Sub "alchemiser-${Stage}-notifications"
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.notifications_v2.lambda_handler.lambda_handler
      Role: !GetAtt NotificationsExecutionRole.Arn
      Layers:
        - !Ref NotificationsLayer
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref AlchemiserEventBus
          SNS_NOTIFICATION_TOPIC_ARN: !Ref TradingNotificationsTopic
          PERFORMANCE_REPORTS_BUCKET: !Ref PerformanceReportsBucket
          TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable
      Events:
        TradeExecutedEvent:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref AlchemiserEventBus
            Pattern:
              source:
                - "alchemiser.execution"
              detail-type:
                - "TradeExecuted"
        # Route WorkflowFailed from ANY alchemiser source to notifications
        # Each Lambda (strategy, portfolio, execution) publishes WorkflowFailed with its own source
        WorkflowFailedEvent:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref AlchemiserEventBus
            Pattern:
              source:
                - prefix: "alchemiser."
              detail-type:
                - "WorkflowFailed"
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          - '.env*'
          - 'the_alchemiser/.env*'
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'
          - 'the_alchemiser/.editorconfig'
          - 'the_alchemiser/**/*.md'

  NotificationsExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: NotificationsPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource:
                  - !Ref TradingNotificationsTopic
              - Effect: Allow
                Action:
                  - dynamodb:Query
                  - dynamodb:GetItem
                  - dynamodb:Scan
                Resource:
                  - !GetAtt TradeLedgerTable.Arn
                  - !Sub "${TradeLedgerTable.Arn}/index/*"
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                Resource:
                  - !Sub "${PerformanceReportsBucket.Arn}/*"

  # Scheduler to trigger Strategy (workflow entry point)
  StrategySchedule:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-strategy-schedule"
        - !Sub "alchemiser-${Stage}-strategy-schedule"
      Description: "Execute trading strategy daily at 9:35 AM New York time"
      ScheduleExpression: "cron(35 9 ? * MON-FRI *)"
      ScheduleExpressionTimezone: "America/New_York"
      FlexibleTimeWindow:
        Mode: "OFF"
      Target:
        Arn: !GetAtt StrategyFunction.Arn
        RoleArn: !GetAtt StrategySchedulerRole.Arn
        Input: '{"mode": "trade"}'
        RetryPolicy:
          MaximumRetryAttempts: 1

  StrategySchedulerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: scheduler.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeStrategy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt StrategyFunction.Arn

  # ========== DATA LAMBDA ==========
  # Fetches historical market data from Alpaca and stores in S3 as Parquet
  # Runs nightly after market close to refresh data for all strategy symbols
  DataFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-data"
        - !Sub "alchemiser-${Stage}-data"
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.data_v2.lambda_handler.lambda_handler
      Role: !GetAtt DataExecutionRole.Arn
      Layers:
        - !Ref DataLayer
      Timeout: 900  # 15 minutes max for full data
      MemorySize: 1024
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref AlchemiserEventBus
          MARKET_DATA_BUCKET: !Ref MarketDataBucket
          ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
          ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
          ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/**/*.clj'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          - '.env*'
          - 'the_alchemiser/.env*'
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'
          - 'the_alchemiser/.editorconfig'
          - 'the_alchemiser/**/*.md'

  DataExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DataPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt MarketDataBucket.Arn
                  - !Sub "${MarketDataBucket.Arn}/*"

  # Scheduler to trigger Data (nightly after market close)
  DataSchedule:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-data-schedule"
        - !Sub "alchemiser-${Stage}-data-schedule"
      Description: "Refresh market data daily at 10 PM UTC (Mon-Fri)"
      ScheduleExpression: "cron(0 22 ? * MON-FRI *)"
      ScheduleExpressionTimezone: "UTC"
      FlexibleTimeWindow:
        Mode: "OFF"
      Target:
        Arn: !GetAtt DataFunction.Arn
        RoleArn: !GetAtt DataSchedulerRole.Arn
        Input: '{}'
        RetryPolicy:
          MaximumRetryAttempts: 2

  DataSchedulerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: scheduler.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeData
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt DataFunction.Arn

  # ============================================================================
  # END MICROSERVICES ARCHITECTURE
  # ============================================================================

  # ============================================================================
  # OBSERVABILITY: CloudWatch Logs Insights & Dashboard
  # ============================================================================
  
  # CloudWatch Dashboard for at-a-glance monitoring
  # Note: Log groups are auto-created by Lambda; we reference them by name
  AlchemiserDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-monitoring"
        - !Sub "alchemiser-${Stage}-monitoring"
      DashboardBody: !Sub
        - |
          {
            "widgets": [
              {
                "type": "log",
                "properties": {
                  "title": "Latest Errors & Warnings (All Lambdas)",
                  "region": "${AWS::Region}",
                  "query": "SOURCE '${StrategyLog}'\n| SOURCE '${PortfolioLog}'\n| SOURCE '${ExecutionLog}'\n| SOURCE '${NotificationsLog}'\n| SOURCE '${DataLog}'\n| fields @timestamp, @log, level, event, module, correlation_id, message\n| filter level in ['ERROR', 'WARN', 'WARNING']\n| sort @timestamp desc\n| limit 50"
                },
                "x": 0,
                "y": 0,
                "width": 24,
                "height": 8
              },
              {
                "type": "log",
                "properties": {
                  "title": "Errors by Correlation ID (Trace Workflow Runs)",
                  "region": "${AWS::Region}",
                  "query": "SOURCE '${StrategyLog}'\n| SOURCE '${PortfolioLog}'\n| SOURCE '${ExecutionLog}'\n| SOURCE '${NotificationsLog}'\n| SOURCE '${DataLog}'\n| fields @timestamp, @log, level, event, module, correlation_id, message\n| filter level = 'ERROR'\n| sort @timestamp desc\n| limit 100"
                },
                "x": 0,
                "y": 8,
                "width": 24,
                "height": 8
              },
              {
                "type": "log",
                "properties": {
                  "title": "Recent Workflow Runs (by correlation_id)",
                  "region": "${AWS::Region}",
                  "query": "SOURCE '${StrategyLog}'\n| SOURCE '${PortfolioLog}'\n| SOURCE '${ExecutionLog}'\n| SOURCE '${NotificationsLog}'\n| SOURCE '${DataLog}'\n| fields @timestamp, @log, level, event, correlation_id, module\n| filter event in ['SignalGenerated', 'RebalancePlanned', 'TradeExecuted', 'WorkflowCompleted', 'WorkflowFailed']\n| sort @timestamp desc\n| limit 50"
                },
                "x": 0,
                "y": 16,
                "width": 24,
                "height": 8
              }
            ]
          }
        - StrategyLog: !Sub "/aws/lambda/${StrategyFunction}"
          PortfolioLog: !Sub "/aws/lambda/${PortfolioFunction}"
          ExecutionLog: !Sub "/aws/lambda/${ExecutionFunction}"
          NotificationsLog: !Sub "/aws/lambda/${NotificationsFunction}"
          DataLog: !Sub "/aws/lambda/${DataFunction}"

Outputs:
  TradeLedgerTableName:
    Description: "DynamoDB table for trade ledger persistence"
    Value: !Ref TradeLedgerTable
    Export:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-TradeLedgerTable"
        - !Sub "alchemiser-${Stage}-TradeLedgerTable"

  PerformanceReportsBucketName:
    Description: "S3 bucket for strategy performance CSV reports"
    Value: !Ref PerformanceReportsBucket
    Export:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-PerformanceReportsBucket"
        - !Sub "alchemiser-${Stage}-PerformanceReportsBucket"

  MarketDataBucketName:
    Description: "S3 bucket for historical market data (Parquet files)"
    Value: !Ref MarketDataBucket
    Export:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-MarketDataBucket"
        - !Sub "alchemiser-${Stage}-MarketDataBucket"

  DeploymentStage:
    Description: "Deployed stage"
    Value: !Ref Stage
  
  StackNameUsed:
    Description: "Stack name used for resource naming"
    Value: !If [ HasStackName, !Ref StackName, !Sub "alchemiser-${Stage}" ]


  DashboardURL:
    Description: "CloudWatch Dashboard for monitoring errors and warnings"
    Value: !Sub "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${AlchemiserDashboard}"

  LogsInsightsURL:
    Description: "CloudWatch Logs Insights for querying logs across all Lambdas"
    Value: !Sub "https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#logsV2:logs-insights"
