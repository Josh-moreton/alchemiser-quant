# yaml-language-server: $schema=https://raw.githubusercontent.com/aws/serverless-application-model/main/samtranslator/validator/sam_schema/schema.json
# yaml-language-server: disable-validation
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  The Alchemiser Quantitative Trading System

  Multi-strategy algorithmic trading engine deployed as an AWS Lambda Function

Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
      - ephemeral
    Description: Deployment stage (dev, prod, or ephemeral)
  
  StackName:
    Type: String
    Default: ""
    Description: Optional override for stack-specific resource naming (used for ephemeral stacks)
  
  Env:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
      - ephemeral
    Description: Environment type for resource configuration
  
  ArtifactPrefix:
    Type: String
    Default: ""
    Description: S3 prefix for artifacts (used for ephemeral stack isolation)

  AlpacaKey:
    Type: String
    Default: ""
    NoEcho: true
    Description: Alpaca API Key (used only in dev; leave blank for prod)

  AlpacaSecret:
    Type: String
    Default: ""
    NoEcho: true
    Description: Alpaca API Secret (used only in dev; leave blank for prod)

  AlpacaEndpoint:
    Type: String
    Default: https://paper-api.alpaca.markets/v2
    Description: Alpaca API endpoint; defaults to paper for dev, live is used for prod

  EmailPassword:
    Type: String
    Default: ""
    NoEcho: true
    Description: Email SMTP password for dev notifications (optional)

  # Runtime configuration parameters (override via CD for each environment)
  LoggingLevel:
    Type: String
    Default: INFO
    Description: LOGGING__LEVEL for application logging

  DslMaxWorkers:
    Type: String
    Default: "7"
    Description: ALCHEMISER_DSL_MAX_WORKERS (string to align with Lambda env var type)


  # Production-only parameters (only used when Stage=prod)
  ProdAlpacaKey:
    Type: String
    Default: ""
    NoEcho: true
    Description: Alpaca API Key for production (required when Stage=prod)

  ProdAlpacaSecret:
    Type: String
    Default: ""
    NoEcho: true
    Description: Alpaca API Secret for production (required when Stage=prod)

  ProdAlpacaEndpoint:
    Type: String
    Default: https://api.alpaca.markets
    Description: Alpaca API endpoint for production

  ProdEmailPassword:
    Type: String
    Default: ""
    NoEcho: true
    Description: Email SMTP password for production notifications (optional)

  # Microservices deployment parameters
  EnableMicroservices:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"
    Description: Enable separate Lambda microservices deployment

  # Strategy configuration: now defined in code defaults. Override via env only if required.

Conditions:
  IsDev: !Equals [ !Ref Stage, dev ]
  IsEphemeral: !Equals [ !Ref Stage, ephemeral ]
  HasStackName: !Not [ !Equals [ !Ref StackName, "" ] ]
  UseStackNameForResources: !Or [ !Condition IsEphemeral, !Condition HasStackName ]
  IsMicroservicesEnabled: !Equals [ !Ref EnableMicroservices, "true" ]
  # Disable monolithic schedule when microservices are enabled (or ephemeral)
  IsMonolithicScheduleEnabled: !And
    - !Not [ !Condition IsMicroservicesEnabled ]
    - !Not [ !Condition IsEphemeral ]

Globals:
  Function:
    Timeout: 900 # 15 minutes - max for Lambda
    MemorySize: 512
    Environment:
      Variables:
        # Logging
        LOGGING__LEVEL: !Ref LoggingLevel
        # Stage awareness for code-level profiles
        APP__STAGE: !If [ IsDev, "dev", "prod" ]
        # Alpaca Configuration
        ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
        ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
        ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
        # Email Configuration
        EMAIL__SMTP_SERVER: smtp.mail.me.com
        EMAIL__SMTP_PORT: 587
        EMAIL__FROM_EMAIL: joshuamoreton1@icloud.com
        EMAIL__TO_EMAIL: notifications@rwxt.org
        EMAIL__NEUTRAL_MODE: true
        EMAIL__PASSWORD: !If [ IsDev, !Ref EmailPassword, !Ref ProdEmailPassword ]
        # Strategy DSL configuration now comes from code defaults; override via env only if necessary
        # STRATEGY__DSL_FILES: '["1-KMLM.clj","2-Nuclear.clj","5-Coin.clj","6-TQQQ-FLT.clj"]'
        # STRATEGY__DSL_ALLOCATIONS: '{"1-KMLM.clj":0.4,"2-Nuclear.clj":0.25,"5-Coin.clj":0.1,"6-TQQQ-FLT.clj":0.25}'

        # DSL parallelism configuration
        ALCHEMISER_DSL_MAX_WORKERS: !Ref DslMaxWorkers

        # Trade ledger DynamoDB table
        TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable

  # Strategy configuration now packaged with code; env overrides optional

  # (no additional Globals keys)

Resources:
  # DynamoDB Table for trade ledger persistence
  TradeLedgerTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !If 
        - UseStackNameForResources
        - !Sub "${StackName}-trade-ledger"
        - !Sub "alchemiser-trade-ledger-${Stage}"
      BillingMode: PAY_PER_REQUEST
      
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
        - AttributeName: GSI3PK
          AttributeType: S
        - AttributeName: GSI3SK
          AttributeType: S
        - AttributeName: GSI4PK
          AttributeType: S
        - AttributeName: GSI4SK
          AttributeType: S
      
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      
      GlobalSecondaryIndexes:
        # GSI1: Query by correlation_id
        - IndexName: GSI1-CorrelationIndex
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        
        # GSI2: Query by symbol
        - IndexName: GSI2-SymbolIndex
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        
        # GSI3: Query by strategy
        - IndexName: GSI3-StrategyIndex
          KeySchema:
            - AttributeName: GSI3PK
              KeyType: HASH
            - AttributeName: GSI3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        
        # GSI4: Query snapshots by correlation_id
        - IndexName: GSI4-CorrelationSnapshotIndex
          KeySchema:
            - AttributeName: GSI4PK
              KeyType: HASH
            - AttributeName: GSI4SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      
      SSESpecification:
        SSEEnabled: true
        # Use AWS-managed encryption (not KMS) to avoid requiring additional IAM permissions
      
      Tags:
        - Key: Environment
          Value: !Ref Stage
        - Key: Service
          Value: trade-ledger

  # Lambda Layer for dependencies
  DependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-dependencies"
        - !Sub "the-alchemiser-dependencies-${Stage}"
      Description: Dependencies for The Alchemiser Quantitative Trading System
      ContentUri: dependencies/
      CompatibleRuntimes:
        - python3.12
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.12

  TradingSystemFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-lambda"
        - !Sub "the-alchemiser-v2-lambda-${Stage}"
      PackageType: Zip
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.lambda_handler.lambda_handler
      Role: !GetAtt TradingSystemExecutionRole.Arn
      Layers:
        - !Ref DependenciesLayer
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        # Include only the the_alchemiser package
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/**/*.clj'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          # Sensitive files (security)
          - '.env*'
          - 'the_alchemiser/.env*'

          # Python cache and build artifacts
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'

          # IDE and editor files
          - 'the_alchemiser/.editorconfig'

          # Documentation within the_alchemiser
          - 'the_alchemiser/**/*.md'

  # Dead Letter Queue for failed trading executions
  TradingSystemDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-dlq"
        - !Sub "the-alchemiser-dlq-${Stage}"
      MessageRetentionPeriod: 1209600 # 14 days
      VisibilityTimeout: 60

  # ============================================================================
  # MICROSERVICES ARCHITECTURE (Enabled via EnableMicroservices parameter)
  # ============================================================================

  # EventBridge Event Bus for async domain event communication
  AlchemiserEventBus:
    Type: AWS::Events::EventBus
    Condition: IsMicroservicesEnabled
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-events"
        - !Sub "alchemiser-trading-${Stage}"

  # SQS Queue for reliable trade execution with DLQ
  ExecutionQueue:
    Type: AWS::SQS::Queue
    Condition: IsMicroservicesEnabled
    Properties:
      QueueName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-execution-queue"
        - !Sub "alchemiser-execution-${Stage}"
      VisibilityTimeout: 900  # 15 mins for execution
      MessageRetentionPeriod: 345600  # 4 days
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ExecutionDLQ.Arn
        maxReceiveCount: 3

  ExecutionDLQ:
    Type: AWS::SQS::Queue
    Condition: IsMicroservicesEnabled
    Properties:
      QueueName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-execution-dlq"
        - !Sub "alchemiser-execution-dlq-${Stage}"
      MessageRetentionPeriod: 1209600  # 14 days

  # Policy to allow EventBridge to send messages to SQS
  ExecutionQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Condition: IsMicroservicesEnabled
    Properties:
      Queues:
        - !Ref ExecutionQueue
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sqs:SendMessage
            Resource: !GetAtt ExecutionQueue.Arn
            Condition:
              ArnEquals:
                aws:SourceArn: !GetAtt RebalancePlannedRule.Arn

  # EventBridge Rules for event routing
  WorkflowStartedRule:
    Type: AWS::Events::Rule
    Condition: IsMicroservicesEnabled
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-workflow-started"
        - !Sub "alchemiser-workflow-started-${Stage}"
      EventBusName: !Ref AlchemiserEventBus
      EventPattern:
        source:
          - alchemiser.orchestrator
        detail-type:
          - TradingWorkflowStarted
      Targets:
        - Id: StrategyTarget
          Arn: !GetAtt StrategyFunction.Arn

  WorkflowStartedPermission:
    Type: AWS::Lambda::Permission
    Condition: IsMicroservicesEnabled
    Properties:
      FunctionName: !Ref StrategyFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt WorkflowStartedRule.Arn

  SignalGeneratedRule:
    Type: AWS::Events::Rule
    Condition: IsMicroservicesEnabled
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-signal-generated"
        - !Sub "alchemiser-signal-generated-${Stage}"
      EventBusName: !Ref AlchemiserEventBus
      EventPattern:
        source:
          - alchemiser.strategy
        detail-type:
          - SignalGenerated
      Targets:
        - Id: PortfolioTarget
          Arn: !GetAtt PortfolioFunction.Arn

  SignalGeneratedPermission:
    Type: AWS::Lambda::Permission
    Condition: IsMicroservicesEnabled
    Properties:
      FunctionName: !Ref PortfolioFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt SignalGeneratedRule.Arn

  RebalancePlannedRule:
    Type: AWS::Events::Rule
    Condition: IsMicroservicesEnabled
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-rebalance-planned"
        - !Sub "alchemiser-rebalance-planned-${Stage}"
      EventBusName: !Ref AlchemiserEventBus
      EventPattern:
        source:
          - alchemiser.portfolio
        detail-type:
          - RebalancePlanned
      Targets:
        - Id: ExecutionQueueTarget
          Arn: !GetAtt ExecutionQueue.Arn

  # Orchestrator Lambda - Publishes WorkflowStarted to EventBridge
  OrchestratorFunction:
    Type: AWS::Serverless::Function
    Condition: IsMicroservicesEnabled
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-orchestrator"
        - !Sub "the-alchemiser-orchestrator-${Stage}"
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.orchestration.lambda_handler.lambda_handler
      Role: !GetAtt OrchestratorExecutionRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Timeout: 900
      MemorySize: 512
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref AlchemiserEventBus
          ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
          ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
          ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
          TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable
          LOGGING__LEVEL: !Ref LoggingLevel
          APP__STAGE: !If [ IsDev, "dev", "prod" ]
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/**/*.clj'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          - '.env*'
          - 'the_alchemiser/.env*'
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'
          - 'the_alchemiser/.editorconfig'
          - 'the_alchemiser/**/*.md'

  OrchestratorExecutionRole:
    Type: AWS::IAM::Role
    Condition: IsMicroservicesEnabled
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: OrchestratorPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt TradeLedgerTable.Arn
                  - !Sub "${TradeLedgerTable.Arn}/index/*"

  # Strategy Lambda - Signal generation microservice
  StrategyFunction:
    Type: AWS::Serverless::Function
    Condition: IsMicroservicesEnabled
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-strategy"
        - !Sub "the-alchemiser-strategy-${Stage}"
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.strategy_v2.lambda_handler.lambda_handler
      Role: !GetAtt StrategyExecutionRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Timeout: 300
      MemorySize: 1024
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref AlchemiserEventBus
          ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
          ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
          ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
          TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable
          LOGGING__LEVEL: !Ref LoggingLevel
          ALCHEMISER_DSL_MAX_WORKERS: !Ref DslMaxWorkers
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/**/*.clj'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          - '.env*'
          - 'the_alchemiser/.env*'
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'
          - 'the_alchemiser/.editorconfig'
          - 'the_alchemiser/**/*.md'

  StrategyExecutionRole:
    Type: AWS::IAM::Role
    Condition: IsMicroservicesEnabled
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: StrategyPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt TradeLedgerTable.Arn
                  - !Sub "${TradeLedgerTable.Arn}/index/*"

  # Portfolio Lambda - Rebalance planning microservice
  PortfolioFunction:
    Type: AWS::Serverless::Function
    Condition: IsMicroservicesEnabled
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-portfolio"
        - !Sub "the-alchemiser-portfolio-${Stage}"
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.portfolio_v2.lambda_handler.lambda_handler
      Role: !GetAtt PortfolioExecutionRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Timeout: 300
      MemorySize: 1024
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref AlchemiserEventBus
          ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
          ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
          ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
          TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable
          LOGGING__LEVEL: !Ref LoggingLevel
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/**/*.clj'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          - '.env*'
          - 'the_alchemiser/.env*'
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'
          - 'the_alchemiser/.editorconfig'
          - 'the_alchemiser/**/*.md'

  PortfolioExecutionRole:
    Type: AWS::IAM::Role
    Condition: IsMicroservicesEnabled
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: PortfolioPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt TradeLedgerTable.Arn
                  - !Sub "${TradeLedgerTable.Arn}/index/*"

  # Execution Lambda - Trade execution microservice (triggered via SQS)
  ExecutionFunction:
    Type: AWS::Serverless::Function
    Condition: IsMicroservicesEnabled
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-execution"
        - !Sub "the-alchemiser-execution-${Stage}"
      Runtime: python3.12
      CodeUri: ./
      Handler: the_alchemiser.execution_v2.lambda_handler.lambda_handler
      Role: !GetAtt ExecutionExecutionRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Timeout: 600
      MemorySize: 1024
      # Note: Concurrency is limited by SQS BatchSize: 1 which processes one message at a time
      # WebSocket connections are cleaned up after each execution via cleanup_all_instances()
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref AlchemiserEventBus
          ALPACA__KEY: !If [ IsDev, !Ref AlpacaKey, !Ref ProdAlpacaKey ]
          ALPACA__SECRET: !If [ IsDev, !Ref AlpacaSecret, !Ref ProdAlpacaSecret ]
          ALPACA__ENDPOINT: !If [ IsDev, !Ref AlpacaEndpoint, !Ref ProdAlpacaEndpoint ]
          TRADE_LEDGER__TABLE_NAME: !Ref TradeLedgerTable
          LOGGING__LEVEL: !Ref LoggingLevel
      Events:
        ExecutionQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt ExecutionQueue.Arn
            BatchSize: 1
            FunctionResponseTypes:
              - ReportBatchItemFailures
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        Include:
          - 'the_alchemiser/**/*.py'
          - 'the_alchemiser/**/*.clj'
          - 'the_alchemiser/config/*.json'
          - 'the_alchemiser/py.typed'
        Exclude:
          - '.env*'
          - 'the_alchemiser/.env*'
          - '**/__pycache__/**'
          - '**/*.pyc'
          - '**/*.pyo'
          - '**/*.egg-info/**'
          - 'the_alchemiser/.editorconfig'
          - 'the_alchemiser/**/*.md'

  ExecutionExecutionRole:
    Type: AWS::IAM::Role
    Condition: IsMicroservicesEnabled
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: ExecutionPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                Resource:
                  - !GetAtt ExecutionQueue.Arn
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                  - dynamodb:BatchWriteItem
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt TradeLedgerTable.Arn
                  - !Sub "${TradeLedgerTable.Arn}/index/*"

  # ========== NOTIFICATIONS LAMBDA ==========
  # Consumes TradeExecuted events and sends email notifications
  NotificationsFunction:
    Type: AWS::Serverless::Function
    Condition: IsMicroservicesEnabled
    Properties:
      FunctionName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-notifications"
        - !Sub "alchemiser-notifications-${Stage}"
      Handler: the_alchemiser.notifications_v2.lambda_handler.lambda_handler
      Runtime: python3.12
      MemorySize: 512
      Timeout: 60
      Role: !GetAtt NotificationsExecutionRole.Arn
      Events:
        TradeExecutedEvent:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref AlchemiserEventBus
            Pattern:
              source:
                - "alchemiser.execution"
              detail-type:
                - "TradeExecuted"

  NotificationsExecutionRole:
    Type: AWS::IAM::Role
    Condition: IsMicroservicesEnabled
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: NotificationsPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource:
                  - !GetAtt AlchemiserEventBus.Arn

  # Scheduler for Orchestrator (microservices mode)
  OrchestratorSchedule:
    Type: AWS::Scheduler::Schedule
    Condition: IsMicroservicesEnabled
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-orchestrator-schedule"
        - !Sub "alchemiser-orchestrator-${Stage}"
      Description: "Execute microservices orchestrator daily at 9:35 AM New York time"
      ScheduleExpression: "cron(35 9 ? * MON-FRI *)"
      ScheduleExpressionTimezone: "America/New_York"
      FlexibleTimeWindow:
        Mode: "OFF"
      Target:
        Arn: !GetAtt OrchestratorFunction.Arn
        RoleArn: !GetAtt OrchestratorSchedulerRole.Arn
        Input: '{"mode": "trade"}'
        RetryPolicy:
          MaximumRetryAttempts: 1

  OrchestratorSchedulerRole:
    Type: AWS::IAM::Role
    Condition: IsMicroservicesEnabled
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: scheduler.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeOrchestrator
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource: !GetAtt OrchestratorFunction.Arn

  # ============================================================================
  # END MICROSERVICES ARCHITECTURE
  # ============================================================================

  # EventBridge Scheduler with proper timezone support and reduced retry policy
  TradingSystemSchedule:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-daily-trading"
        - !Sub "the-alchemiser-daily-trading-${Stage}"
      Description: "Execute quantitative trading system daily at 9:35 AM New York time"
      ScheduleExpression: "cron(35 9 ? * MON-FRI *)"
      ScheduleExpressionTimezone: "America/New_York"
      FlexibleTimeWindow:
        Mode: "OFF"
      Target:
        Arn: !GetAtt TradingSystemFunction.Arn
        RoleArn: !GetAtt SchedulerExecutionRole.Arn
        Input: |
          {
            "mode": "trade"
          }
        RetryPolicy:
          MaximumRetryAttempts: 1 # Reduced from default (185) to prevent excessive retries
        DeadLetterConfig:
          Arn: !GetAtt TradingSystemDLQ.Arn
      # Disable when microservices enabled (they have their own schedule via OrchestratorFunction)
      State: !If [ IsMonolithicScheduleEnabled, "ENABLED", "DISABLED" ]

  # Monthly summary scheduler: runs on the 1st of each month at 00:05 UTC
  MonthlySummarySchedule:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-monthly-summary"
        - !Sub "the-alchemiser-monthly-summary-${Stage}"
      Description: "Send monthly financial summary on the 1st (previous month)"
      ScheduleExpression: "cron(5 0 1 * ? *)"  # 00:05 UTC on day 1
      ScheduleExpressionTimezone: "UTC"
      FlexibleTimeWindow:
        Mode: "OFF"
      Target:
        Arn: !GetAtt TradingSystemFunction.Arn
        RoleArn: !GetAtt SchedulerExecutionRole.Arn
        Input: |
          {
            "action": "monthly_summary"
          }
        RetryPolicy:
          MaximumRetryAttempts: 1
        DeadLetterConfig:
          Arn: !GetAtt TradingSystemDLQ.Arn
      State: !If [ IsEphemeral, "DISABLED", "ENABLED" ]

  # IAM Role for EventBridge Scheduler to invoke Lambda
  SchedulerExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-scheduler-role"
        - !Sub "the-alchemiser-v2-${Stage}-scheduler-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: scheduler.amazonaws.com
            Action: sts:AssumeRole

  # Separate policy for Scheduler role to avoid constant updates
  SchedulerExecutionRolePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: SchedulerLambdaInvokePolicy
      Roles:
        - !Ref SchedulerExecutionRole
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource: !GetAtt TradingSystemFunction.Arn
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt TradingSystemDLQ.Arn

  # IAM Role for Lambda execution
  TradingSystemExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If
        - UseStackNameForResources
        - !Sub "${StackName}-trading-system-role"
        - !Sub "the-alchemiser-v2-${Stage}-trading-system-role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  # Separate policy for Lambda execution role to avoid constant updates
  TradingSystemExecutionRolePolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: TradingSystemPolicy
      Roles:
        - !Ref TradingSystemExecutionRole
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          # CloudWatch Logs (enhanced logging)
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
              - logs:DescribeLogStreams
              - logs:DescribeLogGroups
            Resource: "*"

          # DynamoDB access for trade ledger
          - Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:GetItem
              - dynamodb:Query
              - dynamodb:UpdateItem
              - dynamodb:BatchWriteItem
            Resource:
              - !GetAtt TradeLedgerTable.Arn
              - !Sub "${TradeLedgerTable.Arn}/index/*"


  # CloudWatch Log Group with retention
  TradingSystemLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !If
        - UseStackNameForResources
        - !Sub "/aws/lambda/${StackName}-lambda"
        - !Sub "/aws/lambda/the-alchemiser-v2-lambda-${Stage}"
      RetentionInDays: !If [ IsEphemeral, 3, 30 ]

Outputs:
  TradingSystemFunctionArn:
    Description: "Quantitative Trading System Lambda Function ARN"
    Value: !GetAtt TradingSystemFunction.Arn

  TradingSystemLogGroupName:
    Description: "CloudWatch Log Group for monitoring"
    Value: !If
      - UseStackNameForResources
      - !Sub "/aws/lambda/${StackName}-lambda"
      - !Sub "/aws/lambda/the-alchemiser-v2-lambda-${Stage}"

  TradeLedgerTableName:
    Description: "DynamoDB table for trade ledger persistence"
    Value: !Ref TradeLedgerTable
    Export:
      Name: !If
        - UseStackNameForResources
        - !Sub "${StackName}-TradeLedgerTable"
        - !Sub "the-alchemiser-v2-${Stage}-TradeLedgerTable"

  DeploymentStage:
    Description: "Deployed stage"
    Value: !Ref Stage
  
  StackNameUsed:
    Description: "Stack name used for resource naming"
    Value: !If [ HasStackName, !Ref StackName, !Sub "the-alchemiser-v2-${Stage}" ]
