# Pre-Commit Configuration Guide

## Overview

This project uses production-grade pre-commit hooks to ensure code quality, security, and architectural consistency before code is committed. The hooks are designed to fail fast and catch issues early in the development cycle.

## Philosophy

1. **Run locally what CI runs** - Catch issues before pushing
2. **Fail fast** - Don't waste time on broken code
3. **Consistency** - Match `make` commands exactly
4. **Production-grade** - Security, architecture, and quality gates

## Hooks Enabled

### 1. File Hygiene (pre-commit-hooks)
- **YAML validation** - Ensures valid YAML syntax (excludes AWS SAM templates)
- **TOML validation** - Ensures valid pyproject.toml and other TOML files
- **JSON validation** - Ensures valid JSON (excludes VS Code JSONC configs)
- **Merge conflict detection** - Catches forgotten merge markers
- **Large file prevention** - Blocks files >500KB
- **Line ending normalization** - Enforces LF line endings

### 2. Security (detect-secrets)
- **Secret scanning** - Detects hardcoded credentials, API keys, tokens
- Uses baseline approach (`.secrets.baseline`)
- Excludes lock files, minified JS, and coverage reports

### 3. Code Quality (Ruff)
Runs in 3 stages (order matters):
1. **Format** - Applies consistent style and whitespace normalization
2. **Auto-fix** - Fixes safe lint violations automatically
3. **Lint** - Fails on unfixable lint issues

**Why Ruff replaces legacy hooks:**
- Ruff's `W` rules handle **trailing whitespace** (W291, W293)
- Ruff's `W292` handles **missing final newline**
- Ruff is faster and more comprehensive than standalone tools

### 4. Type Safety (MyPy)
- **Strict type checking** - Enforces type hints across production code
- Uses configuration from `pyproject.toml`
- Progressive migration approach (excludes legacy code until refactored)

### 5. Architecture (Import Linter)
- **Module boundary enforcement** - Prevents architectural violations
- Ensures:
  - `shared/` has no upward dependencies
  - Business modules don't cross-import
  - Event-driven layered architecture is respected
- Configured in `pyproject.toml` via contracts

### 6. Security Scanning (Bandit)
- **Security vulnerability detection** - Finds common security issues
- Supplements Ruff's `S` rules
- Configured in `pyproject.toml` (skips acceptable patterns like `assert` in type narrowing)

### 7. Dead Code Detection (Vulture)
- **Advisory only** - Runs manually, not on every commit
- Detects unused code with 80% confidence threshold
- Run with: `pre-commit run vulture --hook-stage manual --all-files`

## Setup

### First-time Setup
```bash
# Install pre-commit hooks
poetry run pre-commit install

# Test all hooks (optional but recommended)
poetry run pre-commit run --all-files
```

### Updating Hooks
```bash
# Update to latest versions
poetry run pre-commit autoupdate

# Re-run after updates
poetry run pre-commit run --all-files
```

## Usage

### Automatic (Default)
Hooks run automatically on `git commit`:
```bash
git add .
git commit -m "feat: add new feature"
# Hooks run here automatically
```

### Manual Run
Run hooks manually before committing:
```bash
# Run all hooks on staged files
poetry run pre-commit run

# Run all hooks on all files
poetry run pre-commit run --all-files

# Run specific hook
poetry run pre-commit run ruff-format --all-files
poetry run pre-commit run mypy --all-files

# Run advisory checks (manual stage)
poetry run pre-commit run vulture --hook-stage manual --all-files
```

### Bypass (Emergency Only)
⚠️ **Not recommended** - Only use for emergency hotfixes:
```bash
git commit --no-verify -m "hotfix: emergency fix"
```

## Hook Execution Order

Hooks run in this order (by design):
1. File validation (YAML, TOML, JSON, merge conflicts, file size)
2. Secret scanning (detect-secrets)
3. Code formatting (Ruff format)
4. Auto-fix lints (Ruff fix)
5. Lint check (Ruff check)
6. Type check (MyPy)
7. Architecture check (Import Linter)
8. Security scan (Bandit)

## Performance

### Speed Optimizations
- **Incremental runs** - Only checks changed files (when applicable)
- **Parallel execution** - Pre-commit runs hooks in parallel where safe
- **Caching** - MyPy and Ruff use caches to speed up subsequent runs
- **File targeting** - Hooks only run on relevant file types

### Typical Performance
- **Fast commits** (few files changed): 5-10 seconds
- **Full run** (all files): 2-3 minutes first time, 30-60 seconds cached

## Troubleshooting

### Hook Fails - What to Do?

1. **Read the error message** - It tells you what's wrong
2. **Fix the issue** - Most issues auto-fix via `make format`
3. **Re-commit** - Hooks run again automatically

### Common Issues

#### "Ruff format would reformat files"
```bash
# Fix: Run formatter
make format

# Or directly
poetry run ruff format the_alchemiser/
```

#### "MyPy type check failed"
```bash
# Fix: Add type hints or fix type errors
# Check error details in output
poetry run mypy the_alchemiser/
```

#### "Import Linter - architecture violation"
```bash
# Fix: Remove cross-module imports
# See error for specific violation
poetry run lint-imports
```

#### "Bandit found security issue"
```bash
# Fix: Address security concern or add to skip list in pyproject.toml
poetry run bandit -c pyproject.toml -r the_alchemiser/
```

#### "Detect-secrets found secrets"
```bash
# If false positive: Update baseline
poetry run detect-secrets scan . --exclude-files '.*\.lock$|\.git/' > .secrets.baseline

# If real secret: Remove it and rotate credentials
```

### Clean Slate
If hooks are stuck or corrupted:
```bash
# Uninstall hooks
poetry run pre-commit uninstall

# Clear cache
poetry run pre-commit clean

# Reinstall
poetry run pre-commit install

# Test
poetry run pre-commit run --all-files
```

## Integration with Make Commands

Pre-commit hooks match `make` commands exactly:

| Hook                  | Make Command           | Purpose                          |
|-----------------------|------------------------|----------------------------------|
| `ruff-format`         | `make format`          | Code formatting                  |
| `ruff-fix`            | `make format`          | Auto-fix lints                   |
| `ruff-check`          | `make lint`            | Lint checking                    |
| `mypy`                | `make type-check`      | Type checking                    |
| `import-linter`       | `make import-check`    | Architecture enforcement         |
| `bandit`              | (no direct equivalent) | Security scanning                |

Run all quality checks:
```bash
make migration-check  # Runs: lint + type-check + import-check
```

## CI/CD Integration

Pre-commit hooks are also enforced in CI:
- GitHub Actions runs the same hooks
- Prevents broken code from reaching `main`
- Fast feedback loop (fails early in CI)

## Configuration Files

| File                       | Purpose                                    |
|----------------------------|--------------------------------------------|
| `.pre-commit-config.yaml`  | Pre-commit hook definitions                |
| `pyproject.toml`           | Tool configurations (Ruff, MyPy, Bandit)   |
| `.secrets.baseline`        | Known secrets baseline for detect-secrets  |

## Best Practices

1. **Run hooks before pushing** - `pre-commit run --all-files`
2. **Keep hooks updated** - `pre-commit autoupdate` monthly
3. **Don't bypass hooks** - They're there to help you
4. **Fix issues early** - Don't accumulate technical debt
5. **Update baseline when needed** - False positives in secret scanning

## FAQ

### Q: Why so many hooks?
**A:** Each hook serves a specific purpose and catches different classes of issues. Together they provide comprehensive quality gates.

### Q: Can I disable a specific hook?
**A:** Yes, but not recommended. Edit `.pre-commit-config.yaml` and comment out the hook.

### Q: Hooks are slow - how to speed up?
**A:**
- Commit smaller changesets
- Use `make format` before committing (catches format issues early)
- Ensure caches are working (`.mypy_cache`, `.ruff_cache`)

### Q: Hook failed but I don't understand why?
**A:**
1. Read the full error output
2. Run the failing hook manually with `--verbose`
3. Check this guide's troubleshooting section
4. Ask the team or check project documentation

### Q: How do I update the secrets baseline?
**A:**
```bash
# Scan and create new baseline
poetry run detect-secrets scan . --exclude-files '.*\.lock$|\.git/' > .secrets.baseline

# Audit baseline (interactive)
poetry run detect-secrets audit .secrets.baseline
```

## Support

For issues or questions:
1. Check this guide
2. Review hook output carefully
3. Check `pyproject.toml` for tool configurations
4. Consult team documentation
5. Ask in team chat/Slack

## Version Management Requirement

**CRITICAL:** All code changes must bump the version number using semantic versioning:

```bash
# Bug fixes, docs, minor refactors
make bump-patch

# New features, modules, enhancements
make bump-minor

# Breaking changes, API changes
make bump-major
```

Pre-commit hooks do **not** enforce version bumps automatically. This is **your responsibility** before committing.

## References

- [Pre-commit documentation](https://pre-commit.com/)
- [Ruff documentation](https://docs.astral.sh/ruff/)
- [MyPy documentation](https://mypy.readthedocs.io/)
- [Import Linter](https://import-linter.readthedocs.io/)
- [Bandit documentation](https://bandit.readthedocs.io/)
- [detect-secrets documentation](https://github.com/Yelp/detect-secrets)
