name: CD Debug

on:
  # Debug deployments triggered by debug tags
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+-debug.[0-9]+'
  # Allow manual deploys
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_PAGER: ""

jobs:
  deploy-debug:
    runs-on: ubuntu-latest
    environment: debug  # Uses dedicated debug environment secrets
    # Ensure only one deploy runs at a time
    concurrency:
      group: ${{ github.workflow }}-debug
      cancel-in-progress: true

    steps:
      - name: Checkout correct commit
        uses: actions/checkout@v6

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.3
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache venv
        uses: actions/cache@v5
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Install SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Build debug stack
        run: sam build --parallel --template-file template-debug.yaml --config-env debug

      - name: Deploy debug stack
        env:
          ALPACA_KEY: ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENDPOINT: ${{ vars.ALPACA_ENDPOINT }}
        run: |
          if [[ -z "${ALPACA_KEY:-}" || -z "${ALPACA_SECRET:-}" ]]; then
            echo "❌ ALPACA_KEY and ALPACA_SECRET must be set for debug deploy." >&2
            exit 1
          fi
          
          ALPACA_ENDPOINT_PARAM=${ALPACA_ENDPOINT:-"https://paper-api.alpaca.markets/v2"}
          
          sam deploy \
            --config-env debug \
            --no-fail-on-empty-changeset \
            --resolve-s3 \
            --parameter-overrides \
              "Stage=debug" \
              "StackName=alchemiser-debug" \
              "AlpacaKey=$ALPACA_KEY" \
              "AlpacaSecret=$ALPACA_SECRET" \
              "AlpacaEndpoint=$ALPACA_ENDPOINT_PARAM"
          
          echo "✅ Debug stack deployed successfully!"
