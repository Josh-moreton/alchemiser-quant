---
name: Debug Trading System

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  run-trading:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: |
          pip install -U pip
          pip install poetry

      - name: Install dependencies
        run: |
          # Install dependencies for the programmatic interface
          poetry install --only=main

      - name: Run trading via module entry point
        id: run_trading
        env:
          ALPACA_KEY: ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENDPOINT: ${{ secrets.ALPACA_ENDPOINT }}
          EMAIL__FROM_EMAIL: ${{ vars.EMAIL__FROM_EMAIL }}
          EMAIL__TO_EMAIL: ${{ vars.EMAIL__TO_EMAIL }}
          EMAIL__PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          APP__STAGE: dev
          LOGGING__CONSOLE_LEVEL: DEBUG
          LOGGING__LEVEL: DEBUG
        run: |
          set +e
          poetry run python -m the_alchemiser > trading_output.log 2>&1
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          # Detect error patterns even if exit code is 0
          if grep -Eiq '(ERROR|CRITICAL|Traceback|Exception)' trading_output.log; then
            echo "error_detected=true" >> $GITHUB_OUTPUT
            echo "=== Detected error patterns in output ==="
            grep -Ein '(ERROR|CRITICAL|Traceback|Exception)' trading_output.log || true
          else
            echo "error_detected=false" >> $GITHUB_OUTPUT
          fi

          echo "=== Trading System Output ==="
          cat trading_output.log
          echo "=== Exit Code: $exit_code ==="

      - name: Upload logs
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.4.3
        with:
          name: trading-debug-logs
          path: trading_output.log

      - name: Prepare issue content
        if: always() && (steps.run_trading.outputs.exit_code != '0' || steps.run_trading.outputs.error_detected == 'true')
        run: |
          timestamp="$(date -u)"
          cat > issue_content.md << EOF
          # Trading System Debug Failure

          **Workflow Run ID**: ${{ github.run_id }}
          **Exit Code**: ${{ steps.run_trading.outputs.exit_code }}
          **Errors Detected in Log**: ${{ steps.run_trading.outputs.error_detected }}
          **Timestamp**: $timestamp
          **Repository**: ${{ github.repository }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}

          ## Error Lines
          \`\`\`
          EOF
          grep -nEi '(ERROR|CRITICAL|Traceback|Exception)' trading_output.log >> issue_content.md || true
          cat >> issue_content.md << EOF
          \`\`\`

          ## Trading System Output Log

          \`\`\`
          EOF
          cat trading_output.log >> issue_content.md
          cat >> issue_content.md << EOF
          \`\`\`

          ## Debugging Information

          This issue was automatically created because the trading system command
          \`python -m the_alchemiser\` failed with exit code ${{ steps.run_trading.outputs.exit_code }} or error patterns were detected in the output.

          ### Actions

          - 📥 [Download full logs artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - 🔍 [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Next Steps

          1. Review the error output above
          2. Check the imported modules and dependencies
          3. Fix any import or configuration issues
          4. Re-run the workflow to verify the fix
          EOF

      - name: Create issue on failure
        if: always() && (steps.run_trading.outputs.exit_code != '0' || steps.run_trading.outputs.error_detected == 'true')
        uses: peter-evans/create-issue-from-file@e8ef132d6df98ed982188e460ebb3b5d4ef3a9cd # v5
        with:
          title: Trading System Debug Failure – Run ${{ github.run_id }}
          content-filepath: ./issue_content.md
          labels: debug
          assignees: ${{ github.triggering_actor }}
          token: ${{ secrets.GITHUB_TOKEN }}
