---
name: Debug CLI Trade

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  run-cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Poetry
        run: |
          pip install -U pip
          pip install poetry

      - name: Install dependencies
        run: |
          # Always use Poetry for dependency installation to ensure 
          # the project is installed with proper CLI entry points
          poetry install --only=main

      - name: Run CLI trade command
        id: run_cli
        env:
          ALPACA_KEY: ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          ALPACA_ENDPOINT: ${{ secrets.ALPACA_ENDPOINT }}
        run: |
          set +e
          poetry run alchemiser trade > cli_output.log 2>&1
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          echo "=== CLI Trade Output ==="
          cat cli_output.log
          echo "=== Exit Code: $exit_code ==="

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: cli-trade-debug-logs
          path: cli_output.log

      - name: Prepare issue content
        if: steps.run_cli.outputs.exit_code != '0'
        run: |
          timestamp="$(date -u)"
          cat > issue_content.md << EOF
          # CLI Trade Debug Failure

          **Workflow Run ID**: ${{ github.run_id }}
          **Exit Code**: ${{ steps.run_cli.outputs.exit_code }}
          **Timestamp**: $timestamp
          **Repository**: ${{ github.repository }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}

          ## CLI Trade Output Log

          \`\`\`
          EOF
          cat cli_output.log >> issue_content.md
          cat >> issue_content.md << EOF
          \`\`\`

          ## Debugging Information

          This issue was automatically created because the CLI command 
          \`poetry run alchemiser trade\` failed with exit code ${{ steps.run_cli.outputs.exit_code }}.

          ### Actions

          - 📥 [Download full logs artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - 🔍 [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Next Steps

          1. Review the error output above
          2. Check the imported modules and dependencies
          3. Fix any import or configuration issues
          4. Re-run the workflow to verify the fix
          EOF

      - name: Create issue on failure
        if: steps.run_cli.outputs.exit_code != '0'
        uses: peter-evans/create-issue-from-file@e8ef132d6df98ed982188e460ebb3b5d4ef3a9cd # v5
        with:
          title: CLI Trade Debug Failure – Run ${{ github.run_id }}
          content-filepath: ./issue_content.md
          labels: debug
          assignees: ${{ github.triggering_actor }}
          token: ${{ secrets.GITHUB_TOKEN }}