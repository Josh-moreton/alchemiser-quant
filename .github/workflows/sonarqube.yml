name: SonarCloud Scan and Sync Issues

on:
    push:
        branches: [main, feat/**]
    pull_request:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read
    pull-requests: read
    issues: write

jobs:
    sonarqube:
        name: Run SonarQube and Sync
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install sonar-scanner
              uses: warchant/setup-sonar-scanner@v7

            - name: Run SonarCloud Scan
              env:
                  SONAR_HOST_URL: https://sonarcloud.io
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_ORGANIZATION: josh-moreton
              run: |
                  sonar-scanner \
                    -Dsonar.login=${SONAR_TOKEN} \
                    -Dsonar.host.url=${SONAR_HOST_URL} \
                    -Dsonar.organization=${SONAR_ORGANIZATION}

            - name: Set up Python for sync
              if: ${{ success() }}
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install sync deps
              if: ${{ success() }}
              run: |
                  python -m pip install --upgrade pip
                  pip install requests

            - name: SonarCloud â†’ GitHub Issues
              if: ${{ success() }}
              env:
                  SONAR_HOST_URL: https://sonarcloud.io
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_ORGANIZATION: josh-moreton
                  GITHUB_TOKEN: ${{ github.token }}
                  GITHUB_REPOSITORY: ${{ github.repository }}
              run: |
                  python scripts/sonar_to_github_issues.py \
                    --project-key "Josh-moreton_alchemiser-quant" \
                    --severity "CRITICAL,MAJOR,MINOR" \
                    --types "BUG,VULNERABILITY,CODE_SMELL" \
                    --label sonarqube --label tech-debt --label automated
