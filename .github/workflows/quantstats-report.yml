name: QuantStats Report Generator

# Generate tearsheet reports for trading strategies
# Runs after market close on trading days and can be triggered manually

on:
  schedule:
    # Run at 2:00 AM UTC (9 PM ET) Mon-Fri
    - cron: '0 2 * * 1-5'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to query (affects table/bucket names)'
        required: true
        default: 'prod'
        type: choice
        options: [dev, staging, prod]
      days_lookback:
        description: 'Days of history to include in reports'
        required: false
        default: '90'
        type: string

permissions:
  id-token: write  # Required for OIDC
  contents: read

env:
  AWS_PAGER: ""

jobs:
  generate-reports:
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'prod' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "stage=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "lookback=${{ inputs.days_lookback }}" >> $GITHUB_OUTPUT
          else
            echo "stage=prod" >> $GITHUB_OUTPUT
            echo "lookback=90" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            poetry.lock

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            quantstats \
            pandas \
            numpy \
            boto3 \
            alpaca-py \
            pydantic \
            ipython

      - name: Generate QuantStats reports
        env:
          ALPACA_KEY: ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          TRADE_LEDGER_TABLE: alchemiser-${{ steps.env.outputs.stage }}-trade-ledger
          REPORTS_BUCKET: alchemiser-${{ steps.env.outputs.stage }}-reports
          DAYS_LOOKBACK: ${{ steps.env.outputs.lookback }}
        run: |
          cd scripts
          python generate_quantstats_reports.py

      - name: Summary
        if: always()
        run: |
          echo "## QuantStats Report Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ steps.env.outputs.stage }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Days lookback:** ${{ steps.env.outputs.lookback }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports are uploaded to S3 bucket \`alchemiser-${{ steps.env.outputs.stage }}-reports\`" >> $GITHUB_STEP_SUMMARY
          echo "in the \`quantstats/YYYY-MM-DD/\` prefix with a \`manifest.json\` file." >> $GITHUB_STEP_SUMMARY
