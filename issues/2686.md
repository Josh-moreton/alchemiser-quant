### **Issue: Generate Deterministic Account Snapshots for Reporting**

To support downstream PDF report generation, we need a **deterministic snapshot** that consolidates data from both **Alpaca** and our **internal DynamoDB trade ledger**.  
This snapshot will act as the single source of truth for metrics, ensuring that reports are reproducible and do not depend on live API calls.

---

#### **Objective**
Produce a consistent, versioned data snapshot representing the full account state at the end of each trading cycle.  
Snapshots will be stored in **DynamoDB** and referenced by the PDF Report Lambda via Step Functions input.

---

#### **Functional Requirements**
- Aggregate data from:
  - **Alpaca API** — account balances, positions, orders, realised/unrealised P&L, fees  
  - **Internal DynamoDB trade ledger** — transaction history, allocations, strategy-level performance
- Combine into a unified schema with clear typing and timestamping  
- Write the snapshot to DynamoDB at a deterministic key:
  - `PK: SNAPSHOT#{account_id}`, `SK: SNAP#{YYYY-MM-DDTHH:mm:ssZ}`
- Emit an event or Step Functions output containing:
  - `account_id`, `period`, and `snapshot_id`
- Ensure data completeness and integrity checks (balances vs. ledger totals)

---

#### **Technical Requirements**
- Runs as part of the **main trading Lambda** post-cycle completion  
- Uses existing Alpaca client and DynamoDB trade ledger repository
- Schema defined via **Pydantic v2 DTOs** for strong typing and validation  
- Version each schema change (`snapshot_version`) to maintain backward compatibility  
- Store in **DynamoDB** with TTL for 90 days automatic expiration
- Query strategy performance directly from DynamoDB trade ledger using GSIs
- Emit Step Functions input for the downstream PDF Report Lambda

---

#### **DynamoDB Schema**

```
Table: alchemiser-trade-ledger-{stage}

Snapshot Item:
  PK: "SNAPSHOT#{account_id}"
  SK: "SNAP#{period_end_timestamp}"
  EntityType: "SNAPSHOT"
  
  snapshot_id: uuid
  snapshot_version: "1.0"
  account_id: string
  period_start: ISO timestamp
  period_end: ISO timestamp
  correlation_id: string
  
  alpaca_account: JSON
  alpaca_positions: JSON array
  alpaca_orders: JSON array
  
  internal_ledger: {
    ledger_id: string
    total_trades: number
    total_buy_value: decimal
    total_sell_value: decimal
    strategies_active: string array
    strategy_performance: {
      strategy_name: {
        total_trades, buy_trades, sell_trades,
        total_buy_value, total_sell_value,
        gross_pnl, realized_pnl, symbols_traded,
        first_trade_at, last_trade_at
      }
    }
  }
  
  checksum: string
  ttl: number (90 days from creation)
  created_at: ISO timestamp
```

---

#### **Acceptance Criteria**
- ✅ Snapshot generated at end of every trading cycle  
- ✅ Snapshot written to DynamoDB with deterministic key structure
- ✅ Snapshot passes Pydantic schema validation and checksum integrity  
- ✅ Report Lambda can retrieve snapshots from DynamoDB by account_id + timestamp
- ✅ Report Lambda can reproduce identical PDFs from the same snapshot  
- ✅ No live Alpaca calls in reporting functions  
- ✅ Snapshots queryable by account_id and time range using DynamoDB Query
- ✅ Strategy performance metrics computed from DynamoDB trade ledger
- ✅ TTL automatically expires old snapshots after 90 days

---

#### **Implementation Plan**
- [ ] Define Pydantic snapshot schema with strategy performance metrics
- [ ] Create `AccountSnapshotRepository` for DynamoDB operations
- [ ] Extend main trading Lambda to build snapshot from Alpaca + DynamoDB ledger
- [ ] Query strategy performance from DynamoDB trade ledger using GSI3 (strategy index)
- [ ] Write snapshot to DynamoDB with deterministic PK/SK
- [ ] Configure TTL attribute for 90-day expiration
- [ ] Emit Step Functions payload with `snapshot_id`
- [ ] Add schema validation + checksum verification tests  
- [ ] Add integration test ensuring PDF Lambda retrieves from DynamoDB correctly
- [ ] Add query patterns: get latest snapshot, get snapshot by date range

---

#### **Benefits of DynamoDB Approach**
- ✅ **Fast retrieval**: Query snapshots by account + date in single-digit milliseconds
- ✅ **No connection overhead**: Serverless-native, no VPC or connection pooling
- ✅ **Built-in TTL**: Automatic cleanup after 90 days
- ✅ **Queryable history**: Get latest snapshot or query by date range
- ✅ **Cost-effective**: Pay only for reads/writes (~$0.03/month estimated)
- ✅ **Single source of truth**: All trading data in one DynamoDB table
